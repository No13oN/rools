# Архітектура (Канонічна)

## Призначення
Цей документ задає універсальну інформаційну архітектуру для мультиагентної роботи у файловому середовищі з Git-аудитом.

## Сфера застосування
- `Сценарій A`: діюче середовище (brownfield).
- `Сценарій B`: нове середовище (greenfield).

## Базові принципи
1. Жодних конкурентних записів у спільний mutable-файл.
2. Обмін між агентами лише через inbox-повідомлення (файл-на-повідомлення).
3. База знань є read-heavy та оновлюється керовано.
4. Логи append-only.
5. Git використовується як журнал змін і механізм rollback.

## Канонічна логічна модель
```text
/project-root
├── 00_EXCHANGE/
│   ├── inbox_supervisor/
│   ├── inbox_researcher/
│   ├── inbox_writer/
│   └── inbox_coder/
├── 10_KNOWLEDGE/
│   ├── index.md
│   ├── protocols/
│   ├── world_model/
│   └── templates/
├── 20_LOGS/
│   ├── sessions/
│   ├── decisions/
│   └── errors/
├── 99_SYSTEM/
│   ├── config/
│   └── routing/
└── 90_ARCHIVE/
```

## Модель запису
- `00_EXCHANGE/*`: create-only повідомлення для передачі між агентами.
- `10_KNOWLEDGE/*`: лише керовані апдейти (proposal -> review -> apply).
- `20_LOGS/*`: тільки додавання.
- `90_ARCHIVE/*`: незмінне зберігання legacy-матеріалів.

## Контракти даних
Операційні Markdown-файли мають містити YAML frontmatter.

Приклад: контекст місії
```yaml
---
type: mission_context
status: active
priority: high
owner: supervisor
last_updated: 2026-02-17T00:00:00Z
---
```

Приклад: архітектурне рішення
```yaml
---
id: ADR-001
date: 2026-02-17
status: accepted
tags: [architecture, process]
---
```

## Політика конкурентності
- Заборонено: кілька агентів пишуть у спільний mutable-файл.
- Дозволено: окремий файл-повідомлення в `inbox_{recipient}`.
- Рекомендований шаблон імені:
  - `msg_{YYYYMMDD_HHMMSS}_{sender}_{topic}.md`

## Політика retrieval
Порядок читання для агента:
1. Активний контекст/місія.
2. Індекс бази знань.
3. Конкретний протокол/шаблон для поточної задачі.
4. Релевантні останні логи (за потреби).

## Політика безпеки
- Секрети не зберігаються в Markdown.
- Підозрілі токени редагуються на `[REDACTED]`.
- `.env*` і чутливі артефакти виключаються з контролю версій.

## KPI
- Time-to-Context.
- Retrieval Accuracy.
- Stale Context Rate.
- Conflict Rate (ціль: 0).

## Два сценарії впровадження
### Сценарій A: діюче середовище
- Міграція поетапно через `MIGRATION_RUNBOOK.md`.
- Legacy-файли переносяться в архів після валідації.

### Сценарій B: нове середовище
- Одразу старт з канонічної структури.
- Контракти іменування, frontmatter та inbox-модель діють з першого дня.

## Open Issues (V1 vs V2)
1. `scratchpad.md` (V1) vs `inbox_*` (V2):
Рішення: канонічно використовувати лише `inbox_*` для міжагентного обміну.

2. Прямі записи в `10_KNOWLEDGE` (V1-практика) vs proposal-flow (V2):
Рішення: прямі записи заборонені без явного погодження.

3. Формат логів `Markdown` (V1) vs `JSONL` (V2):
Рішення: мінімум — markdown append-only; для автоматизації дозволено додатково `JSONL`.

4. Різні назви зон (`00_CONTEXT` vs `00_EXCHANGE`, `20_LOGS` vs `20_IMMUTABLE_LOGS`):
Рішення: канонічні назви цього документа мають пріоритет.

## Definition of Done
1. Є один канонічний архітектурний документ.
2. Обмін між агентами йде лише через inbox.
3. База знань оновлюється керовано.
4. Логи є append-only і придатні до аудиту.
